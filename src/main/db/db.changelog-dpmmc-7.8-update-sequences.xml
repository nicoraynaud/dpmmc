<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <preConditions>
        <dbms type="postgresql" />
    </preConditions>

    <changeSet author="rayni84" id="3773b0f2-e4af-11e4-8a00-1681e6b88ec1-1">
        <createProcedure>
CREATE OR REPLACE FUNCTION update_sequences() RETURNS varchar AS $$
DECLARE
seqs RECORD;
val INTEGER;
BEGIN
FOR seqs IN select s.relname as seq, t.relname as tab, a.attname as col
from pg_class s
join pg_depend d on d.objid=s.oid and d.classid='pg_class'::regclass and d.refclassid='pg_class'::regclass
join pg_class t on t.oid=d.refobjid
join pg_namespace n on n.oid=t.relnamespace
join pg_attribute a on a.attrelid=t.oid and a.attnum=d.refobjsubid
where s.relkind='S' and d.deptype='a' LOOP

execute 'SELECT MAX('|| seqs.col ||')+1 FROM ' || seqs.tab INTO val;
execute 'ALTER SEQUENCE ' || seqs.seq || ' restart with ' || val;
RAISE NOTICE 'Set sequence % with nextval at %', seqs.seq, val;
END LOOP;
RETURN 'ok';
END;
$$ LANGUAGE plpgsql;
        </createProcedure>
        <rollback>
DROP FUNCTION update_sequences();
        </rollback>
    </changeSet>

    <changeSet author="rayni84" id="3773b0f2-e4af-11e4-8a00-1681e6b88ec1-2">
        <sql>
            SELECT update_sequences();
        </sql>
    </changeSet>

    <changeSet author="rayni84" id="3773b0f2-e4af-11e4-8a00-1681e6b88ec1-3">
        <sql>
DROP FUNCTION update_sequences();
        </sql>
    </changeSet>

</databaseChangeLog>
